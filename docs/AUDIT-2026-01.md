# Defrag Codebase Audit - January 2026

## Executive Summary

Audit of the Defrag (frags) codebase revealed **31 actionable items** across security, testing, documentation, and code quality. The backend is well-structured with solid auth and abuse controls. Primary gaps are in testing coverage and documentation.

---

## ðŸ”´ HIGH PRIORITY (Do First)

### H1. Turnstile "Fail Open" Security Issue
**File:** [synth_engine/api/turnstile.py](synth_engine/api/turnstile.py#L76-L80)
**Risk:** If Cloudflare is DDoS'd or unavailable, turnstile verification passes
**Fix:** Change to fail-closed with circuit breaker pattern
```python
# Current (lines 76-80): returns True on timeout/error
except httpx.TimeoutException:
    return True  # DANGER: Fail open
```
**Effort:** 2h | **Impact:** Critical for bot protection

---

### H2. JWT Secret Auto-Generation
**File:** [synth_engine/config.py](synth_engine/config.py#L24)
**Risk:** If `SYNTH_JWT_SECRET` not set, secrets regenerate on restart â†’ all tokens invalidate
**Fix:** Make it a required env var (fail startup if missing)
```python
jwt_secret: str = Field(default_factory=lambda: secrets.token_urlsafe(48))  # DANGEROUS
```
**Effort:** 30m | **Impact:** Session stability

---

### H3. Print Statements Exposing Errors
**File:** [synth_engine/api/ai.py](synth_engine/api/ai.py) (lines 221, 227, 521, 608, 734, 831)
**Risk:** Error details + stack traces in logs could leak sensitive info
**Fix:** Replace `print()` with structured logging (already have `abuse_logger`)
**Effort:** 1h | **Impact:** Operational security

---

### H4. Empty Exception Handlers
**Files:** 
- [synth_engine/api/main.py](synth_engine/api/main.py#L215) - bare `except: pass`
- [synth_engine/api/main.py](synth_engine/api/main.py#L491)
- [synth_engine/api/main.py](synth_engine/api/main.py#L806)
- [synth_engine/api/main.py](synth_engine/api/main.py#L827)
- [synth_engine/api/ai.py](synth_engine/api/ai.py#L43)
**Risk:** Silent failures make debugging impossible
**Fix:** Add logging or handle specifically
**Effort:** 1h | **Impact:** Debuggability

---

## ðŸŸ  MEDIUM PRIORITY (Next Sprint)

### M1. Create `.env.example` File
**Status:** Missing
**Fix:** Document all required/optional env vars
```bash
# Required
SYNTH_DATABASE_URL=postgresql://...
SYNTH_JWT_SECRET=<generate with openssl rand -hex 48>
SYNTH_STRIPE_SECRET_KEY=sk_...

# Optional - AI
SYNTH_CLOUDFLARE_ACCOUNT_ID=
SYNTH_CLOUDFLARE_API_TOKEN=
...
```
**Effort:** 1h | **Impact:** Onboarding

---

### M2. Write README.md
**File:** [README.md](README.md)
**Status:** Contains only `# frags`
**Needs:**
- Project description
- Architecture overview
- Setup instructions
- API documentation link
- Contributing guidelines
**Effort:** 3h | **Impact:** Contributor onboarding

---

### M3. Add Backend Tests
**Status:** Only [tests/test_billing.py](tests/test_billing.py) exists (151 lines)
**Missing:**
- [ ] `tests/test_auth.py` - JWT, password hashing, dev admin
- [ ] `tests/test_profiles.py` - CRUD, computed layers
- [ ] `tests/test_ai.py` - Chat, embed, abuse controls
- [ ] `tests/test_constellations.py` - Graph operations
- [ ] `tests/test_abuse.py` - Rate limiting, concurrency
**Effort:** 8h | **Impact:** Deployment confidence

---

### M4. Add Frontend Tests
**Status:** No test files found
**Needs:**
- [ ] `__tests__/components/` - Component unit tests
- [ ] `__tests__/hooks/` - Custom hook tests
- [ ] `cypress/` or `playwright/` - E2E tests
**Effort:** 8h | **Impact:** Regression prevention

---

### M5. Replace Console Logs in Frontend
**Files:**
- [frontend/src/app/billing/success/page.tsx](frontend/src/app/billing/success/page.tsx#L21)
- [frontend/src/app/pricing/page.tsx](frontend/src/app/pricing/page.tsx#L66)
- [frontend/src/app/dashboard/page.tsx](frontend/src/app/dashboard/page.tsx#L331)
- [frontend/src/app/error.tsx](frontend/src/app/error.tsx#L14)
- [frontend/src/app/settings/page.tsx](frontend/src/app/settings/page.tsx#L56)
**Fix:** Use proper error tracking (Sentry, LogRocket) or remove
**Effort:** 1h | **Impact:** Production debugging

---

### M6. Complete Phase 2: Quota Enforcement
**Status:** In abuse controls todo (from previous session)
**Needs:**
- Monthly quota counters per plan tier
- Usage limit checks before AI calls
- Warning thresholds (80%, 90%)
**Effort:** 4h | **Impact:** Cost control

---

### M7. Add API Response Type Consistency
**Issue:** Some endpoints return `{"status": "success/error"}`, others don't
**Files:** Various AI endpoints return mixed formats
**Fix:** Standardize response envelope or use proper HTTP status codes
**Effort:** 2h | **Impact:** API usability

---

## ðŸŸ¢ LOW PRIORITY (Backlog)

### L1. Update Dependencies
**File:** [pyproject.toml](pyproject.toml)
- `bcrypt==4.0.1` â†’ current is 4.2.x
- Run `pip-audit` for security vulnerabilities
**Effort:** 1h | **Impact:** Security patches

---

### L2. Add Accessibility Attributes
**Status:** Only 4 `aria-*` usages found across frontend
**Needs:**
- `aria-label` on icon buttons
- `aria-live` on loading states
- `role` attributes on custom components
- Keyboard navigation testing
**Effort:** 4h | **Impact:** A11y compliance

---

### L3. Add Module Docstrings
**Missing in:**
- `synth_engine/compute/` modules
- `synth_engine/fusion/` modules
- `synth_engine/graph/` modules
**Effort:** 2h | **Impact:** Code maintainability

---

### L4. Clean Up Empty Migration
**File:** Check for empty alembic migrations with `pass` in upgrade/downgrade
**Effort:** 30m | **Impact:** DB clarity

---

### L5. Cloudflare TTS Implementation
**File:** [synth_engine/ai/providers/cloudflare.py](synth_engine/ai/providers/cloudflare.py)
**Status:** `supports_text_to_speech` returns False (not implemented)
**Effort:** 2h (when Cloudflare releases TTS) | **Impact:** Feature completeness

---

## ðŸ“Š Summary by Category

| Category | High | Medium | Low | Total |
|----------|------|--------|-----|-------|
| Security | 3 | 0 | 1 | 4 |
| Testing | 0 | 2 | 0 | 2 |
| Documentation | 0 | 2 | 1 | 3 |
| Code Quality | 1 | 3 | 2 | 6 |
| Features | 0 | 1 | 1 | 2 |
| **Total** | **4** | **8** | **5** | **17** |

---

## âœ… Positive Findings

- âœ… No hardcoded secrets in codebase
- âœ… SQLAlchemy ORM prevents SQL injection
- âœ… Comprehensive auth system (JWT + dev admin bypass)
- âœ… Rate limiting and concurrency controls implemented
- âœ… Security headers middleware in place
- âœ… Input validation on AI endpoints
- âœ… Structured audit logging for admin actions
- âœ… Good error states on frontend pages
- âœ… PWA support with iOS optimizations
- âœ… Abuse controls with metrics endpoint

---

## Recommended Sprint Plan

### Week 1: Security Hardening
- [ ] H1: Fix turnstile fail-open
- [ ] H2: Make JWT secret required
- [ ] H3: Replace print with logging
- [ ] H4: Fix empty exception handlers
- [ ] M1: Create .env.example

### Week 2: Testing Foundation
- [ ] M3: Add backend tests (auth, profiles, AI)
- [ ] M6: Complete quota enforcement

### Week 3: Documentation & Polish
- [ ] M2: Write README.md
- [ ] M5: Replace console.logs
- [ ] L2: Add a11y attributes

### Ongoing
- [ ] M4: Frontend tests (parallel effort)
- [ ] L1: Dependency updates (monthly)
